<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Giảng Viên - Nhập Điểm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h3 class="text-primary">QUẢN LÝ ĐIỂM SINH VIÊN - Giảng viên</h3>
    <hr>
    <div class="row">
        <div class="col-md-4">
            <div class="card p-3 shadow-sm">
                <h5>Nhập điểm mới</h5>
                <div class="mb-2">
                    <label>Mã Sinh viên</label>
                    <input type="text" id="sId" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Môn học</label>
                    <input type="text" id="subj" class="form-control">
                </div>
                <div class="mb-2">
                    <label>Điểm</label>
                    <input type="number" id="score" class="form-control" step="0.1">
                </div>
                <button class="btn btn-success w-100 mt-2" onclick="submitGrade()">Ký & Gửi cho Khoa</button>
            </div>
        </div>
        <div class="col-md-8">
            <h5>Danh sách điểm đã nhập</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>SV</th>
                        <th>Môn</th>
                        <th>Điểm</th>
                        <th>Trạng thái</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="lecturerTable"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Tự động tải dữ liệu khi trang web được mở
window.onload = loadMyGrades;

/**
 * Hàm tải danh sách điểm từ Database tập trung
 * Sử dụng API /api/grades/pending để hiển thị các điểm đang chờ duyệt
 */
async function loadMyGrades() {
    try {
        // Gọi API lấy danh sách điểm từ SQLite chung
        const response = await fetch('/api/grades/pending');
        if (!response.ok) throw new Error("Không thể tải dữ liệu");

        const grades = await response.json();
        const tableBody = document.getElementById('lecturerTable');

        let html = '';
        grades.forEach(g => {
            // Xác định badge dựa trên trạng thái (mặc định là PENDING cho dữ liệu mới)
            const statusBadge = g.status === 'APPROVED' ? 'bg-success' : 'bg-warning';

            html += `
                <tr>
                    <td>${g.student_id}</td>
                    <td>${g.subject}</td>
                    <td><strong>${g.score}</strong></td>
                    <td><span class="badge ${statusBadge}">${g.status}</span></td>
                    <td>
                        ${g.status === 'PENDING' ?
                            `<button class="btn btn-sm btn-outline-secondary" disabled>Chờ duyệt...</button>` :
                            `<small class="text-muted">Đã khóa: ${g.hash ? g.hash.substring(0,8) : 'N/A'}</small>`}
                    </td>
                </tr>`;
        });
        tableBody.innerHTML = html;
    } catch (error) {
        console.error("Lỗi loadGrades:", error);
    }
}

/**
 * Hàm gửi điểm mới lên Server
 * Dữ liệu sẽ được lưu vào file SQLite chung thông qua DBManager
 */
async function submitGrade() {
    // Thu thập dữ liệu từ các thẻ input
    const sId = document.getElementById('sId').value;
    const subj = document.getElementById('subj').value;
    const score = document.getElementById('score').value;

    // Kiểm tra dữ liệu đầu vào đơn giản
    if (!sId || !subj || !score) {
        alert("Vui lòng nhập đầy đủ thông tin!");
        return;
    }

    const data = {
        student_id: sId,
        subject: subj,
        score: parseFloat(score)
    };

    try {
        // Gửi yêu cầu POST tới API /api/grades/add đã cập nhật trong main.py
        const response = await fetch('/api/grades/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        if (response.ok) {
            // Xóa form sau khi gửi thành công
            document.getElementById('sId').value = '';
            document.getElementById('subj').value = '';
            document.getElementById('score').value = '';

            alert("Đã ký và gửi điểm thành công vào hệ thống tập trung!");

            // Tải lại bảng ngay lập tức để cập nhật dữ liệu mới
            await loadMyGrades();
        } else {
            alert("Lỗi server khi lưu điểm.");
        }
    } catch (error) {
        alert("Không thể kết nối tới Server: " + error.message);
    }
}

// Thiết lập tự động làm mới dữ liệu mỗi 5 giây để đồng bộ với các node khác
setInterval(loadMyGrades, 5000);
</script>
</body>
</html>